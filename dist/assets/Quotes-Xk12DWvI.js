import{j as e,S as l,B as w,T as ee,u as se,r as j,t as d,C as N,b as g,s as ae}from"./index-lYTtkRVl.js";import{C as te}from"./CreateQuoteDialog-dFk3QClh.js";import{D as ne,e as le,f as re,g as ce,B as I,b as ie,S as oe,F as T}from"./AppLayout-vg_1wxoQ.js";import{T as M,a as L,b as u,c as r,d as H,e as t}from"./table-D3C8ebmP.js";import{u as de,a as xe,b as me,c as ue,E as he}from"./EmptyState-aWvZLoAQ.js";import{g as K,u as je}from"./useInvoices-DXXy1KMq.js";import{D as Z}from"./download-CvHdGBtJ.js";import{A as pe,a as fe,b as ve,c as Ne,d as ge,e as ye,f as we,g as be}from"./alert-dialog-CJEM0QG8.js";import{I as ke,S as De,a as Ce,b as Se,c as _e,d as E}from"./select-CrR1bKbv.js";import{D as Qe,a as ze,b as Pe,c as m}from"./ThemeToggle-H5MkW5aa.js";import{P as Q,E as Ve}from"./plus-DrMUNdvj.js";import{E as Ae}from"./eye-DVQLVt6d.js";import{T as Fe}from"./trash-2-DkyHMLmO.js";import"./useClients-Gxa163Zc.js";import"./useInventory-CT6otCpq.js";import"./textarea-DmnqyP04.js";const Te={draft:"Návrh",sent:"Odoslaná",accepted:"Prijatá",rejected:"Zamietnutá"},Ee={draft:"secondary",sent:"info",accepted:"success",rejected:"destructive"};function Oe({quoteId:h,open:p,onOpenChange:f}){const{data:a,isLoading:c}=de(h||"");console.log("QuoteDetailDialog render:",{quoteId:h,quote:a,isLoading:c});const i=o=>new Intl.NumberFormat("sk-SK",{style:"currency",currency:"EUR"}).format(o);return e.jsx(ne,{open:p,onOpenChange:f,children:e.jsxs(le,{className:"max-w-[95vw] sm:max-w-[700px] max-h-[90vh] overflow-y-auto",children:[e.jsx(re,{children:e.jsx(ce,{className:"flex items-center gap-3",children:c?e.jsx(l,{className:"h-6 w-32"}):a?e.jsxs("div",{className:"flex w-full items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs("span",{children:["Cenová ponuka ",a?.quote_number]}),a&&e.jsx(I,{variant:Ee[a.status],children:Te[a.status]})]}),e.jsxs(w,{size:"sm",variant:"outline",onClick:()=>K(a),children:[e.jsx(Z,{className:"h-4 w-4 mr-2"}),"Stiahnuť PDF"]})]}):e.jsx("span",{children:"Detail ponuky"})})}),c?e.jsxs("div",{className:"space-y-4 py-4",children:[e.jsx(l,{className:"h-20 w-full"}),e.jsx(l,{className:"h-40 w-full"}),e.jsx(l,{className:"h-20 w-40 ml-auto"})]}):a?e.jsxs("div",{className:"space-y-8 py-4",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-8 text-sm",children:[e.jsxs("div",{children:[e.jsx("h4",{className:"font-semibold text-muted-foreground mb-1",children:"Klient"}),e.jsx("div",{className:"font-medium text-lg",children:a.client?.contact_name}),a.client?.company_name&&e.jsx("div",{className:"text-muted-foreground",children:a.client.company_name}),e.jsxs("div",{className:"text-muted-foreground mt-1",children:[a.client?.email&&e.jsx("div",{children:a.client.email}),a.client?.phone&&e.jsx("div",{children:a.client.phone}),a.client?.address&&e.jsxs("div",{children:[a.client.address,", ",a.client?.postal_code]})]})]}),e.jsx("div",{className:"text-right",children:e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-muted-foreground",children:"Vytvorené"}),e.jsx("div",{children:new Date(a.created_at).toLocaleDateString("sk-SK")})]}),a.valid_until&&e.jsxs("div",{children:[e.jsx("div",{className:"text-muted-foreground",children:"Platnosť do"}),e.jsx("div",{children:new Date(a.valid_until).toLocaleDateString("sk-SK")})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-muted-foreground",children:"Vytvoril"}),e.jsx("div",{children:a.created_by_user?.full_name||"Neznámy užívateľ"})]})]})})]}),e.jsx("div",{className:"border rounded-lg overflow-hidden",children:e.jsxs(M,{children:[e.jsx(L,{children:e.jsxs(u,{className:"bg-muted/50",children:[e.jsx(r,{children:"Položka"}),e.jsx(r,{className:"text-right",children:"Množstvo"}),e.jsx(r,{className:"text-right",children:"Cena/ks"}),e.jsx(r,{className:"text-right",children:"Spolu"})]})}),e.jsxs(H,{children:[a.items?.map(o=>e.jsxs(u,{children:[e.jsx(t,{className:"font-medium",children:o.description}),e.jsxs(t,{className:"text-right",children:[o.quantity," ks"]}),e.jsx(t,{className:"text-right",children:i(o.unit_price)}),e.jsx(t,{className:"text-right",children:i(o.total)})]},o.id)),(!a.items||a.items.length===0)&&e.jsx(u,{children:e.jsx(t,{colSpan:4,className:"text-center text-muted-foreground py-4",children:"Žiadne položky"})})]})]})}),e.jsxs("div",{className:"flex flex-col items-end gap-2 border-t pt-4",children:[e.jsxs("div",{className:"flex justify-between w-full max-w-[300px] text-sm text-muted-foreground",children:[e.jsx("span",{children:"Základ (bez DPH):"}),e.jsx("span",{children:i(a.subtotal)})]}),e.jsxs("div",{className:"flex justify-between w-full max-w-[300px] text-sm text-muted-foreground",children:[e.jsxs("span",{children:["DPH (",a.tax_rate,"%):"]}),e.jsx("span",{children:i(a.tax_amount)})]}),e.jsxs("div",{className:"flex justify-between w-full max-w-[300px] text-lg font-bold text-primary mt-2 border-t border-dashed pt-2",children:[e.jsx("span",{children:"Spolu:"}),e.jsx("span",{children:i(a.total)})]})]}),a.notes&&e.jsxs("div",{className:"bg-muted/30 p-4 rounded-lg text-sm",children:[e.jsx("h4",{className:"font-semibold mb-1",children:"Poznámka"}),e.jsx("p",{className:"text-muted-foreground whitespace-pre-wrap",children:a.notes})]})]}):e.jsx("div",{className:"text-center py-8 text-muted-foreground",children:"Cenová ponuka sa nenašla"})]})})}function Ie({open:h,onOpenChange:p,quoteNumber:f,onConfirm:a,isDeleting:c=!1}){return e.jsx(pe,{open:h,onOpenChange:p,children:e.jsxs(fe,{children:[e.jsxs(ve,{children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"flex h-12 w-12 items-center justify-center rounded-full bg-destructive/10",children:e.jsx(ee,{className:"h-6 w-6 text-destructive"})}),e.jsx(Ne,{children:"Vymazať cenovú ponuku"})]}),e.jsxs(ge,{className:"text-left pt-4",children:["Naozaj chcete vymazať cenovú ponuku ",e.jsxs("strong",{className:"text-foreground",children:['"',f,'"']}),"?",e.jsx("br",{}),e.jsx("br",{}),"Táto akcia je nevratná a ponuka bude trvalo odstránená vrátane všetkých položiek a rezervácií."]})]}),e.jsxs(ye,{children:[e.jsx(we,{disabled:c,children:"Zrušiť"}),e.jsx(be,{onClick:i=>{i.preventDefault(),a()},disabled:c,className:"bg-destructive hover:bg-destructive/90",children:c?"Vymazávam...":"Vymazať"})]})]})})}const O={draft:"Návrh",sent:"Odoslaná",accepted:"Prijatá",rejected:"Zamietnutá"},Me={draft:"secondary",sent:"info",accepted:"success",rejected:"destructive"};function as(){const{user:h}=se(),[p,f]=j.useState(""),[a,c]=j.useState("all"),[i,o]=j.useState(null),[B,z]=j.useState(!1),[R,b]=j.useState(!1),[y,k]=j.useState(null),{data:x,isLoading:v,isError:D,error:P}=xe({status:a!=="all"?a:void 0,search:p||void 0}),U=me(),$=je(),V=ue(),A=h?.role==="admin",F=h?.role==="manager";j.useEffect(()=>{D&&(console.error("Error loading quotes:",P),d.error("Nepodarilo sa načítať cenové ponuky"))},[D,P]);const C=s=>new Intl.NumberFormat("sk-SK",{style:"currency",currency:"EUR"}).format(s),G=x?.reduce((s,n)=>s+n.total,0)||0,J=x?.filter(s=>s.status==="accepted").reduce((s,n)=>s+n.total,0)||0,W=x?.length?Math.round(x.filter(s=>s.status==="accepted").length/x.length*100):0,S=async(s,n)=>{try{await U.mutateAsync({quoteId:s,status:n}),d.success("Status ponuky aktualizovaný")}catch{d.error("Nepodarilo sa aktualizovať status")}},X=async s=>{try{await $.mutateAsync(s),d.success("Faktúra vytvorená")}catch{d.error("Nepodarilo sa vytvoriť faktúru")}},Y=async s=>{try{const{data:n,error:_}=await ae.from("quotes").select(`
          *,
          client:clients(id, contact_name, company_name, email, phone, address),
          items:quote_items(*)
        `).eq("id",s.id).single();if(_)throw _;n&&(K(n),d.success("PDF vygenerované"))}catch(n){console.error("Error generating PDF:",n),d.error("Nepodarilo sa vygenerovať PDF")}},q=async()=>{if(y)try{await V.mutateAsync(y.id),d.success("Cenová ponuka vymazaná"),k(null)}catch(s){console.error("Delete quote error:",s);const n=s?.message||"Nepodarilo sa vymazať ponuku";d.error(n)}};return e.jsxs(ie,{title:"Cenové ponuky",children:[e.jsxs("div",{className:"space-y-6 animate-fade-in",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row gap-4 justify-between",children:[e.jsxs("div",{className:"flex flex-1 gap-3",children:[e.jsxs("div",{className:"relative flex-1 max-w-md",children:[e.jsx(oe,{className:"absolute left-3 top-1/2 h-4 w-4 -translate-y-1/2 text-muted-foreground"}),e.jsx(ke,{placeholder:"Hľadať podľa čísla, klienta...",value:p,onChange:s=>f(s.target.value),className:"pl-9"})]}),e.jsxs(De,{value:a,onValueChange:c,children:[e.jsx(Ce,{className:"w-40",children:e.jsx(Se,{placeholder:"Status"})}),e.jsxs(_e,{children:[e.jsx(E,{value:"all",children:"Všetky statusy"}),Object.entries(O).map(([s,n])=>e.jsx(E,{value:s,children:n},s))]})]})]}),e.jsxs(e.Fragment,{children:[e.jsx(w,{onClick:()=>b(!0),className:"md:hidden min-h-[44px] min-w-[44px]",size:"icon",title:"Nová ponuka",children:e.jsx(Q,{className:"h-4 w-4"})}),e.jsxs(w,{onClick:()=>b(!0),className:"hidden md:flex",children:[e.jsx(Q,{className:"h-4 w-4 mr-2"}),"Nová ponuka"]})]})]}),e.jsxs("div",{className:"grid gap-4 md:grid-cols-4",children:[e.jsx(N,{className:"shadow-soft",children:e.jsx(g,{className:"pt-6",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"Celkom ponúk"}),v?e.jsx(l,{className:"h-8 w-16 mt-1"}):e.jsx("p",{className:"text-2xl font-semibold",children:x?.length||0})]}),e.jsx(T,{className:"h-8 w-8 text-muted-foreground/50"})]})})}),e.jsx(N,{className:"shadow-soft",children:e.jsx(g,{className:"pt-6",children:e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"Celková hodnota"}),v?e.jsx(l,{className:"h-8 w-24 mt-1"}):e.jsx("p",{className:"text-2xl font-semibold",children:C(G)})]})})}),e.jsx(N,{className:"shadow-soft",children:e.jsx(g,{className:"pt-6",children:e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"Prijaté ponuky"}),v?e.jsx(l,{className:"h-8 w-24 mt-1"}):e.jsx("p",{className:"text-2xl font-semibold text-success",children:C(J)})]})})}),e.jsx(N,{className:"shadow-soft",children:e.jsx(g,{className:"pt-6",children:e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"Úspešnosť"}),v?e.jsx(l,{className:"h-8 w-16 mt-1"}):e.jsxs("p",{className:"text-2xl font-semibold",children:[W,"%"]})]})})})]}),e.jsx(N,{className:"shadow-soft",children:e.jsx(g,{className:"p-0",children:e.jsxs(M,{children:[e.jsx(L,{children:e.jsxs(u,{children:[e.jsx(r,{children:"Číslo"}),e.jsx(r,{children:"Klient"}),e.jsx(r,{children:"Status"}),e.jsx(r,{className:"text-right",children:"Suma"}),e.jsx(r,{children:"Platnosť do"}),e.jsx(r,{children:"Vytvoril"}),e.jsx(r,{className:"w-12"})]})}),e.jsx(H,{children:v?Array.from({length:5}).map((s,n)=>e.jsxs(u,{children:[e.jsx(t,{children:e.jsx(l,{className:"h-5 w-24"})}),e.jsx(t,{children:e.jsx(l,{className:"h-5 w-32"})}),e.jsx(t,{children:e.jsx(l,{className:"h-5 w-20"})}),e.jsx(t,{children:e.jsx(l,{className:"h-5 w-20"})}),e.jsx(t,{children:e.jsx(l,{className:"h-5 w-24"})}),e.jsx(t,{children:e.jsx(l,{className:"h-5 w-28"})}),e.jsx(t,{children:e.jsx(l,{className:"h-5 w-8"})})]},n)):D?e.jsx(u,{children:e.jsx(t,{colSpan:7,className:"text-center py-8 text-destructive",children:"Nepodarilo sa načítať dáta. Skúste obnoviť stránku."})}):x?.length===0?e.jsx(u,{children:e.jsx(t,{colSpan:7,className:"p-0",children:e.jsx(he,{icon:e.jsx(T,{className:"h-full w-full"}),title:"Zatiaľ žiadne cenové ponuky",description:"Vytvorte cenovú ponuku pre klienta a začnite predávať.",action:{label:"Vytvoriť ponuku",onClick:()=>setCreateQuoteDialogOpen(!0),icon:e.jsx(Q,{className:"h-4 w-4"})}})})}):x?.map(s=>e.jsxs(u,{className:"cursor-pointer hover:bg-muted/50",children:[e.jsx(t,{children:e.jsx("span",{className:"font-medium text-foreground",children:s.quote_number})}),e.jsx(t,{children:e.jsxs("div",{children:[e.jsx("p",{className:"font-medium text-foreground",children:s.client?.contact_name||"-"}),s.client?.company_name&&e.jsx("p",{className:"text-sm text-muted-foreground",children:s.client.company_name})]})}),e.jsx(t,{children:e.jsx(I,{variant:Me[s.status],children:O[s.status]})}),e.jsx(t,{className:"text-right font-medium",children:C(s.total)}),e.jsx(t,{children:e.jsx("span",{className:"text-sm text-muted-foreground",children:s.valid_until?new Date(s.valid_until).toLocaleDateString("sk-SK"):"-"})}),e.jsx(t,{children:e.jsx("span",{className:"text-sm text-muted-foreground",children:s.created_by_user?.full_name||"-"})}),e.jsx(t,{children:e.jsxs(Qe,{children:[e.jsx(ze,{asChild:!0,children:e.jsx(w,{variant:"ghost",size:"icon-sm",children:e.jsx(Ve,{className:"h-4 w-4"})})}),e.jsxs(Pe,{align:"end",children:[e.jsxs(m,{onSelect:n=>{n.preventDefault(),o(s.id),z(!0)},children:[e.jsx(Ae,{className:"h-4 w-4 mr-2"}),"Zobraziť"]}),e.jsxs(m,{onClick:()=>Y(s),children:[e.jsx(Z,{className:"h-4 w-4 mr-2"}),"Stiahnuť PDF"]}),s.status==="draft"&&e.jsx(m,{onClick:()=>S(s.id,"sent"),children:"Odoslať klientovi"}),s.status==="sent"&&e.jsxs(e.Fragment,{children:[e.jsx(m,{onClick:()=>S(s.id,"accepted"),children:"Označiť ako prijatú"}),e.jsx(m,{onClick:()=>S(s.id,"rejected"),children:"Označiť ako zamietnutú"})]}),s.status==="accepted"&&(A||F)&&e.jsx(m,{onClick:()=>X(s.id),children:"Vytvoriť faktúru"}),e.jsx(m,{children:"Duplikovať"}),(A||F)&&e.jsxs(m,{className:"text-destructive",onClick:()=>k({id:s.id,number:s.quote_number}),children:[e.jsx(Fe,{className:"h-4 w-4 mr-2"}),"Vymazať"]})]})]})})]},s.id))})]})})})]}),e.jsx(te,{open:R,onOpenChange:b}),e.jsx(Oe,{quoteId:i,open:B,onOpenChange:z}),e.jsx(Ie,{open:!!y,onOpenChange:s=>!s&&k(null),quoteNumber:y?.number||"",onConfirm:q,isDeleting:V.isPending})]})}export{as as default};
