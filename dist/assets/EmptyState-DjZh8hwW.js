import{c as M,u as f,o as q,s as a,j as _,g as h,B as j}from"./index-ixxTEzIM.js";import{u as E}from"./ThemeToggle-mam2t0E5.js";import{u as g}from"./AppLayout-BqQJj8es.js";import{d as I}from"./useClients-B5nG56wM.js";const F=[["rect",{width:"16",height:"20",x:"4",y:"2",rx:"2",key:"1nb95v"}],["line",{x1:"8",x2:"16",y1:"6",y2:"6",key:"x4nwl0"}],["line",{x1:"16",x2:"16",y1:"14",y2:"18",key:"wjye3r"}],["path",{d:"M16 10h.01",key:"1m94wz"}],["path",{d:"M12 10h.01",key:"1nrarc"}],["path",{d:"M8 10h.01",key:"19clt8"}],["path",{d:"M12 14h.01",key:"1etili"}],["path",{d:"M8 14h.01",key:"6423bh"}],["path",{d:"M12 18h.01",key:"mhygvu"}],["path",{d:"M8 18h.01",key:"lrp35t"}]],P=M("calculator",F);let m=[{id:"1",quote_number:"CP-2024-0001",client_id:"1",status:"sent",valid_until:new Date(Date.now()+10080*60*1e3).toISOString(),subtotal:2e3,discount:0,shipping:0,tax_rate:20,tax_amount:400,total:2400,notes:"Ponuka na nový hardware",pdf_url:null,created_by:"1",created_at:new Date(Date.now()-2880*60*1e3).toISOString(),updated_at:new Date().toISOString(),client:I.find(t=>t.id==="1"),created_by_user:{id:"1",full_name:"Ján Novák",email:"jan@example.com",phone:null,avatar_url:null,region_id:null,theme_preference:"system",is_active:!0,created_at:new Date().toISOString(),updated_at:new Date().toISOString()}}];function R(t){const{user:u,isDemo:n}=f();return E({queryKey:["quotes",t,n],queryFn:async()=>{let e=[];if(n)e=[...m];else{console.log("Fetching quotes from Supabase...");let r=a.from("quotes").select(`
            *,
            client:clients(id, contact_name, company_name)
          `).order("created_at",{ascending:!1});t?.status&&(r=r.eq("status",t.status)),t?.clientId&&(r=r.eq("client_id",t.clientId)),t?.search&&(r=r.or(`quote_number.ilike.%${t.search}%`));const{data:i,error:o}=await r;if(console.log("Quotes fetch result:",{data:i,error:o}),o)throw console.error("Error fetching quotes:",o),o;e=i}if(n&&(t?.status&&(e=e.filter(r=>r.status===t.status)),t?.clientId&&(e=e.filter(r=>r.client_id===t.clientId)),t?.search)){const r=t.search.toLowerCase();e=e.filter(i=>i.quote_number.toLowerCase().includes(r)||i.client?.contact_name.toLowerCase().includes(r)||i.client?.company_name?.toLowerCase().includes(r))}return e},enabled:!!u})}function B(t){const{isDemo:u}=f();return E({queryKey:["quotes",t,u],queryFn:async()=>{if(u){const r=m.find(i=>i.id===t);if(!r)throw new Error("Quote not found");return r}const{data:n,error:e}=await a.from("quotes").select(`
                  *,
                  client:clients(id, contact_name, company_name, email, phone, address),
                  items:quote_items(*)
                `).eq("id",t).single();if(e)throw e;return n},enabled:!!t})}async function O(){try{const{data:t,error:u}=await a.rpc("get_next_quote_number");return u?(console.error("Error generating quote number:",u),`CP-${new Date().getFullYear()}-${Date.now().toString().slice(-4)}`):t}catch(t){return console.error("Exception generating quote number:",t),`CP-${new Date().getFullYear()}-${Date.now().toString().slice(-4)}`}}function Y(){const t=q(),{user:u,isDemo:n}=f();return g({mutationFn:async e=>{const r=e.items.reduce((s,y)=>s+y.quantity*y.unit_price,0),i=e.discount||0,o=e.shipping||0,c=Math.max(0,r-i+o),d=20,l=c*(d/100),v=c+l;let p=`CP-${new Date().getFullYear()}-${Math.floor(Math.random()*1e3).toString().padStart(4,"0")}`;if(n){const s={id:Math.random().toString(36).substr(2,9),quote_number:p,client_id:e.client_id,status:"draft",valid_until:e.valid_until||null,subtotal:r,discount:i,shipping:o,tax_rate:d,tax_amount:l,total:v,notes:e.notes||null,pdf_url:null,created_by:u?.id||"demo-user",created_at:new Date().toISOString(),updated_at:new Date().toISOString(),client:I.find(y=>y.id===e.client_id)};return m.unshift(s),s}p=await O();const{data:w,error:x}=await a.from("quotes").insert({quote_number:p,client_id:e.client_id,status:"draft",valid_until:e.valid_until,subtotal:r,discount:i,shipping:o,tax_rate:d,tax_amount:l,total:v,notes:e.notes,created_by:u?.id}).select().single();if(x)throw x;const Q=e.items.map(s=>({quote_id:w.id,description:s.description,quantity:s.quantity,unit_price:s.unit_price,total:s.quantity*s.unit_price,inventory_item_id:s.inventory_item_id})),{error:S}=await a.from("quote_items").insert(Q);if(S)throw S;const C=e.items.filter(s=>s.inventory_item_id);for(const s of C){const{error:y}=await a.from("reservations").insert({inventory_item_id:s.inventory_item_id,quote_id:w.id,client_id:e.client_id,quantity:s.quantity,status:"active"});if(y)throw console.error("Error creating reservation:",y),new Error("Failed to create inventory reservation");const{data:k,error:b}=await a.from("inventory_items").select("qty_reserved").eq("id",s.inventory_item_id).single();if(b)throw console.error("Error fetching inventory:",b),new Error("Failed to fetch inventory data");const{error:D}=await a.from("inventory_items").update({qty_reserved:(k.qty_reserved||0)+s.quantity,updated_at:new Date().toISOString()}).eq("id",s.inventory_item_id);if(D)throw console.error("Error updating inventory:",D),new Error("Failed to update inventory reservation")}return w},onSuccess:()=>{t.invalidateQueries({queryKey:["quotes"]}),t.invalidateQueries({queryKey:["dashboard-stats"]}),t.invalidateQueries({queryKey:["inventory"]})}})}function A(){const t=q(),{isDemo:u}=f();return g({mutationFn:async({quoteId:n,status:e})=>{if(u){const o=m.findIndex(c=>c.id===n);if(o!==-1)return m[o]={...m[o],status:e,updated_at:new Date().toISOString()},m[o];throw new Error("Quote not found")}if(e==="rejected"){const{data:o,error:c}=await a.from("reservations").select("*").eq("quote_id",n);if(!c&&o){for(const d of o){const{data:l,error:v}=await a.from("inventory_items").select("qty_reserved").eq("id",d.inventory_item_id).single();!v&&l&&await a.from("inventory_items").update({qty_reserved:Math.max(0,(l.qty_reserved||0)-d.quantity),updated_at:new Date().toISOString()}).eq("id",d.inventory_item_id)}await a.from("reservations").update({status:"cancelled"}).eq("quote_id",n)}}const{data:r,error:i}=await a.from("quotes").update({status:e,updated_at:new Date().toISOString()}).eq("id",n).select().single();if(i)throw i;return r},onSuccess:()=>{t.invalidateQueries({queryKey:["quotes"]}),t.invalidateQueries({queryKey:["inventory"]})}})}function U(){const t=q(),{isDemo:u}=f();return g({mutationFn:async n=>{if(u){const c=m.findIndex(d=>d.id===n);c!==-1&&m.splice(c,1);return}const{error:e}=await a.from("invoices").update({quote_id:null}).eq("quote_id",n);if(e)throw console.error("Error updating invoices:",e),e;const{data:r,error:i}=await a.from("reservations").select("*").eq("quote_id",n);if(i)console.error("Error fetching reservations:",i);else if(r){for(const c of r){const{data:d,error:l}=await a.from("inventory_items").select("qty_reserved").eq("id",c.inventory_item_id).single();!l&&d&&await a.from("inventory_items").update({qty_reserved:Math.max(0,(d.qty_reserved||0)-c.quantity),updated_at:new Date().toISOString()}).eq("id",c.inventory_item_id)}await a.from("reservations").delete().eq("quote_id",n)}await a.from("quote_items").delete().eq("quote_id",n);const{error:o}=await a.from("quotes").delete().eq("id",n);if(o)throw o},onSuccess:()=>{t.invalidateQueries({queryKey:["quotes"]}),t.invalidateQueries({queryKey:["inventory"]}),t.invalidateQueries({queryKey:["invoices"]})}})}function J({icon:t,title:u,description:n,action:e,size:r="lg",className:i}){const o=r==="sm"?"p-3":r==="md"?"p-4":"p-5",c=r==="sm"?"h-8 w-8":r==="md"?"h-12 w-12":"h-16 w-16",d=r==="sm"?"py-8":r==="md"?"py-12":"py-16",l=r==="sm"?"text-base":r==="md"?"text-lg":"text-xl";return _.jsxs("div",{className:h("flex flex-col items-center text-center animate-fade-in",d,i),children:[_.jsx("div",{className:h("rounded-2xl border-2 border-[hsl(35,30%,70%)] bg-[hsl(35,20%,85%)] mb-4 flex items-center justify-center",o),children:_.jsx("div",{className:h(c,"text-[hsl(30,35%,45%)]"),children:t})}),_.jsx("h3",{className:h("font-display font-semibold text-foreground mb-2",l),children:u}),_.jsx("p",{className:"text-sm text-muted-foreground max-w-md mb-6",children:n}),e&&_.jsxs(j,{onClick:e.onClick,className:"gap-2",children:[e.icon,e.label]})]})}export{P as C,J as E,R as a,A as b,U as c,Y as d,B as u};
