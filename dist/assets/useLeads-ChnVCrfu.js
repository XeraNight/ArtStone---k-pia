import{u as w}from"./ThemeToggle-BXFLgX7M.js";import{u as c,o as _,s as d}from"./index-DjLyfeQv.js";import{u as m}from"./AppLayout-I815TcDq.js";const s=[{id:"1",contact_name:"Martin Kováč",company_name:"StartUp House",email:"martin@startuphouse.sk",phone:"+421 902 111 222",address:null,postal_code:null,region_id:"1",status:"new",source_type:"website_form",source_campaign:null,source_adset:null,source_ad:null,utm_source:null,utm_medium:null,utm_campaign:null,external_lead_id:null,assigned_user_id:null,duplicate_of_lead_id:null,converted_to_client_id:null,notes:"Záujem o webstránku",created_by:null,created_at:new Date().toISOString(),updated_at:new Date().toISOString(),assigned_user:void 0},{id:"2",contact_name:"Jana Veselá",company_name:null,email:"jana.vesela@gmail.com",phone:"+421 904 333 444",address:null,postal_code:null,region_id:"2",status:"contacted",source_type:"facebook_lead_ads",source_campaign:"Spring Promo",source_adset:null,source_ad:null,utm_source:"facebook",utm_medium:"cpc",utm_campaign:"spring_promo",external_lead_id:null,assigned_user_id:"1",duplicate_of_lead_id:null,converted_to_client_id:null,notes:"Volala ohľadom cenníka, poslať ponuku",created_by:null,created_at:new Date(Date.now()-36e5).toISOString(),updated_at:new Date().toISOString(),assigned_user:{id:"1",full_name:"Ján Novák",email:"jan@example.com",phone:null,avatar_url:null,region_id:null,theme_preference:"system",is_active:!0,created_at:new Date().toISOString(),updated_at:new Date().toISOString()}},{id:"3",contact_name:"Firma ABC s.r.o.",company_name:"Firma ABC",email:"info@firmaabc.sk",phone:"+421 905 555 555",address:null,postal_code:null,region_id:"3",status:"offer",source_type:"manual",source_campaign:null,source_adset:null,source_ad:null,utm_source:null,utm_medium:null,utm_campaign:null,external_lead_id:null,assigned_user_id:"2",duplicate_of_lead_id:null,converted_to_client_id:null,notes:"Poslaná cenová ponuka na CRM systém",created_by:"1",created_at:new Date(Date.now()-864e5).toISOString(),updated_at:new Date().toISOString(),assigned_user:{id:"2",full_name:"Mária Kováčová",email:"maria@example.com",phone:null,avatar_url:null,region_id:null,theme_preference:"system",is_active:!0,created_at:new Date().toISOString(),updated_at:new Date().toISOString()}}];function q(n){const{user:o,isDemo:i}=c();return w({queryKey:["leads",n],queryFn:async()=>{let e=[];if(console.log("useLeads: fetching leads",{isDemo:i}),i)e=[...s];else{const{data:t,error:a}=await d.from("leads").select("*").order("created_at",{ascending:!1});if(console.log("useLeads: Supabase response",{dbData:t,error:a}),a)throw console.error("useLeads: Error fetching leads",a),a;e=t}if(n?.status&&(e=e.filter(t=>t.status===n.status)),n?.source&&(e=e.filter(t=>t.source_type===n.source)),n?.regionId&&(e=e.filter(t=>t.region_id===n.regionId)),n?.assignedUserId&&(e=e.filter(t=>t.assigned_user_id===n.assignedUserId)),n?.search){const t=n.search.toLowerCase();e=e.filter(a=>a.contact_name?.toLowerCase().includes(t)||a.email?.toLowerCase().includes(t)||a.company_name?.toLowerCase().includes(t))}return e},enabled:!!o})}function D(){const n=_(),{user:o,isDemo:i}=c();return m({mutationFn:async e=>{if(i){const r={id:crypto.randomUUID(),contact_name:e.contact_name,company_name:e.company_name||null,email:e.email||null,phone:e.phone||null,address:e.address||null,postal_code:e.postal_code||null,region_id:e.region_id||null,status:e.status||"new",source_type:e.source_type||"manual",notes:e.notes||null,assigned_user_id:e.assigned_user_id||o?.id||null,created_by:o?.id||"demo-user",created_at:new Date().toISOString(),updated_at:new Date().toISOString(),source_campaign:null,source_adset:null,source_ad:null,utm_source:null,utm_medium:null,utm_campaign:null,external_lead_id:null,duplicate_of_lead_id:null,converted_to_client_id:null};return s.unshift(r),r}const{data:t,error:a}=await d.from("leads").insert({contact_name:e.contact_name,company_name:e.company_name,email:e.email,phone:e.phone,address:e.address,postal_code:e.postal_code,region_id:e.region_id,status:e.status||"new",source_type:e.source_type||"manual",notes:e.notes,assigned_user_id:e.assigned_user_id||o?.id,created_by:o?.id}).select().single();if(a)throw console.error("Supabase create lead error:",a),a;return t},onSuccess:()=>{n.invalidateQueries({queryKey:["leads"]}),n.invalidateQueries({queryKey:["recent-leads"]}),n.invalidateQueries({queryKey:["dashboard-stats"]})},onError:e=>{console.error("Mutation create lead error:",e)}})}function b(){const n=_(),{isDemo:o}=c();return m({mutationFn:async({id:i,...e})=>{if(o){const r=s.findIndex(u=>u.id===i);if(r!==-1)return s[r]={...s[r],...e,updated_at:new Date().toISOString()},s[r];throw new Error("Lead not found in demo data")}const{data:t,error:a}=await d.from("leads").update({...e,updated_at:new Date().toISOString()}).eq("id",i).select().single();if(a)throw console.error("Supabase update lead error:",a),a;return t},onSuccess:i=>{n.invalidateQueries({queryKey:["leads"]}),n.invalidateQueries({queryKey:["leads",i.id]})},onError:i=>{console.error("Mutation update lead error:",i)}})}function L(){const n=_(),{isDemo:o}=c();return m({mutationFn:async i=>{if(o){const t=s.findIndex(a=>a.id===i);if(t!==-1){s.splice(t,1);return}throw new Error("Lead not found in demo data")}const{error:e}=await d.from("leads").delete().eq("id",i);if(e)throw e},onSuccess:()=>{n.invalidateQueries({queryKey:["leads"]}),n.invalidateQueries({queryKey:["dashboard-stats"]})}})}function K(){const n=_(),{user:o,isDemo:i}=c();return m({mutationFn:async({leadId:e,userId:t})=>{if(i){const u=s.findIndex(l=>l.id===e);if(u!==-1)return s[u]={...s[u],assigned_user_id:t,updated_at:new Date().toISOString()},s[u];throw new Error("Lead not found in demo data")}const{data:a,error:r}=await d.from("leads").update({assigned_user_id:t,updated_at:new Date().toISOString()}).eq("id",e).select().single();if(r)throw r;if(await d.from("activities").insert({entity_type:"lead",entity_id:e,activity_type:"note",title:"Lead priradený",description:"Lead bol priradený novému obchodníkovi",created_by:o?.id}),t&&t!==o?.id){const{data:u}=await d.from("leads").select("contact_name,company_name").eq("id",e).single();await d.from("notifications").insert({user_id:t,type:"new_lead",title:"Nový lead priradený",message:`Lead ${u?.contact_name||u?.company_name||""} vám bol priradený`,entity_type:"lead",entity_id:e})}return a},onSuccess:()=>{n.invalidateQueries({queryKey:["leads"]}),n.invalidateQueries({queryKey:["activities"]})}})}function O(){const n=_(),{user:o,isDemo:i}=c();return m({mutationFn:async({leadId:e,status:t,note:a})=>{if(i){const l=s.findIndex(y=>y.id===e);if(l!==-1)return s[l]={...s[l],status:t,updated_at:new Date().toISOString()},s[l];throw new Error("Lead not found in demo data")}const{data:r,error:u}=await d.from("leads").update({status:t,updated_at:new Date().toISOString()}).eq("id",e).select().single();if(u)throw u;return await d.from("activities").insert({entity_type:"lead",entity_id:e,activity_type:"status_change",title:"Zmena statusu",description:a||`Status zmenený na: ${t}`,created_by:o?.id}),r},onSuccess:()=>{n.invalidateQueries({queryKey:["leads"]}),n.invalidateQueries({queryKey:["activities"]})}})}function C(){const n=_(),{user:o,isDemo:i}=c();return m({mutationFn:async e=>{if(i){const r=s.findIndex(u=>u.id===e);if(r!==-1)return s[r]={...s[r],assigned_user_id:null,updated_at:new Date().toISOString()},s[r];throw new Error("Lead not found in demo data")}const{data:t,error:a}=await d.from("leads").update({assigned_user_id:null,updated_at:new Date().toISOString()}).eq("id",e).select().single();if(a)throw a;return await d.from("activities").insert({entity_type:"lead",entity_id:e,activity_type:"note",title:"Priradenie zrušené",description:"Lead bol oddelený od obchodníka",created_by:o?.id}),t},onSuccess:()=>{n.invalidateQueries({queryKey:["leads"]}),n.invalidateQueries({queryKey:["activities"]})}})}function Q(){const n=_(),{user:o,isDemo:i}=c();return m({mutationFn:async e=>{if(i)throw new Error("Nemôžete konvertovať leady v demo režime");const{data:t,error:a}=await d.from("leads").select("*").eq("id",e).single();if(a)throw a;if(!t)throw new Error("Lead not found");if(t.converted_to_client_id)throw new Error("Tento lead už bol konvertovaný na klienta");if(t.email){const{data:f}=await d.from("clients").select("id, contact_name").eq("email",t.email).single();if(f)throw new Error(`Klient s emailom ${t.email} už existuje`)}const{data:r,error:u}=await d.from("clients").insert({contact_name:t.contact_name,company_name:t.company_name,email:t.email,phone:t.phone,address:t.address,postal_code:t.postal_code,region_id:t.region_id,assigned_user_id:t.assigned_user_id,notes:t.notes,status:"active",converted_from_lead_id:t.id,created_by:o?.id}).select().single();if(u)throw console.error("Error creating client:",u),u;const{data:l,error:y}=await d.from("activities").select("*").eq("entity_type","lead").eq("entity_id",e);if(!y&&l&&l.length>0){const f=l.map(p=>({entity_type:"client",entity_id:r.id,activity_type:p.activity_type,title:p.title,description:p.description,created_by:p.created_by,created_at:p.created_at}));await d.from("activities").insert(f)}const{error:g}=await d.from("leads").update({converted_to_client_id:r.id,converted_at:new Date().toISOString(),status:"won",updated_at:new Date().toISOString()}).eq("id",e);return g&&console.error("Error updating lead:",g),await d.from("activities").insert({entity_type:"client",entity_id:r.id,activity_type:"note",title:"Klient vytvorený z leadu",description:`Klient bol úspešne konvertovaný z leadu "${t.contact_name}"`,created_by:o?.id}),{client:r,lead:t,activitiesCopied:l?.length||0}},onSuccess:e=>{n.invalidateQueries({queryKey:["leads"]}),n.invalidateQueries({queryKey:["clients"]}),n.invalidateQueries({queryKey:["activities"]}),n.invalidateQueries({queryKey:["dashboard-stats"]}),n.invalidateQueries({queryKey:["recent-leads"]})},onError:e=>{console.error("Lead conversion error:",e)}})}export{K as a,b,Q as c,q as d,O as e,L as f,C as g,D as u};
