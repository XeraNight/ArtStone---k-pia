import{r as t,j as e,B as g,n as ae,t as l}from"./index-B6hbsc4X.js";import{d as ne,C as ie}from"./EmptyState-BfRY-wYH.js";import{b as re}from"./useClients-C1EBftGZ.js";import{u as le}from"./useInventory-B7D-RKR_.js";import{L as n,S as Z,a as E,b as O,c as K,d as _,I as o}from"./select-CnNyzaAZ.js";import{T as oe}from"./textarea-BBmDzxRs.js";import{D as ce,e as de,f as me,g as xe,i as he}from"./AppLayout-y_XY-3Je.js";import{T as ue,a as pe,b as $,c,d as je,e as d}from"./table-CHk-b2FV.js";import{T as ve}from"./trash-2-COiQ811e.js";import{P as ge}from"./plus-Kk0QOdRI.js";function Pe({open:I,onOpenChange:P,defaultClientId:m}={}){const[G,J]=t.useState(!1),D=I!==void 0?I:G,x=s=>{P?P(s):J(s)},[N,h]=t.useState(""),[T,F]=t.useState(""),[V,q]=t.useState(""),[i,y]=t.useState([]),[u,M]=t.useState(0),[p,z]=t.useState(0),[f,H]=t.useState("custom"),[b,j]=t.useState(""),[k,Q]=t.useState(1),[B,v]=t.useState(0),w=ne(),{data:r=[]}=re(),{data:L=[]}=le();t.useMemo(()=>{m&&r.length>0&&r.find(a=>a.id===m)&&h(m)},[m,r,D]),t.useMemo(()=>{const s=new URLSearchParams(window.location.search),a=s.get("leadId"),C=s.get("action");if(a&&C==="new"&&r.length>0){const A=r.find(te=>te.lead_origin_id===a);A&&(h(A.id),x(!0))}},[r]);const S=t.useMemo(()=>i.reduce((s,a)=>s+a.quantity*a.unit_price,0),[i]),R=Math.max(0,S-u+p),U=R*.2,W=R+U,X=s=>{if(H(s),s==="custom")j(""),v(0);else{const a=L.find(C=>C.id===s);a&&(j(a.name),v(a.sale_price||0))}},Y=()=>{if(!b){l.error("Popis položky je povinný");return}if(k<=0){l.error("Množstvo musí byť väčšie ako 0");return}const s={id:Math.random().toString(36).substr(2,9),description:b,quantity:k,unit_price:B,inventory_item_id:f==="custom"?void 0:f};y([...i,s]),H("custom"),j(""),Q(1),v(0)},ee=s=>{y(i.filter(a=>a.id!==s))},se=async()=>{if(!N){l.error("Vyberte klienta");return}if(i.length===0){l.error("Pridajte aspoň jednu položku");return}try{await w.mutateAsync({client_id:N,valid_until:T||void 0,notes:V||void 0,discount:u,shipping:p,items:i.map(s=>({description:s.description,quantity:s.quantity,unit_price:s.unit_price,inventory_item_id:s.inventory_item_id}))}),l.success("Cenová ponuka vytvorená"),x(!1),h(""),F(""),q(""),y([]),M(0),z(0),window.history.replaceState({},"",window.location.pathname)}catch(s){console.error("Create quote error:",s),l.error(s.message||"Nepodarilo sa vytvoriť cenovú ponuku"),s.details&&l.error(s.details)}};return e.jsx(ce,{open:D,onOpenChange:x,children:e.jsxs(de,{className:"max-w-[95vw] sm:max-w-[800px] max-h-[90vh] overflow-y-auto",children:[e.jsx(me,{children:e.jsx(xe,{children:"Vytvoriť cenovú ponuku"})}),e.jsxs("div",{className:"grid gap-6 py-4",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(n,{children:"Klient *"}),e.jsxs(Z,{value:N,onValueChange:h,children:[e.jsx(E,{children:e.jsx(O,{placeholder:"Vyberte klienta"})}),e.jsx(K,{children:r.map(s=>e.jsxs(_,{value:s.id,children:[s.contact_name," ",s.company_name?`(${s.company_name})`:""]},s.id))})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(n,{children:"Platnosť do"}),e.jsx(o,{type:"date",value:T,onChange:s=>F(s.target.value)})]})]}),e.jsxs("div",{className:"space-y-4 border rounded-lg p-4 bg-muted/20",children:[e.jsxs("div",{className:"flex items-center gap-2 font-medium",children:[e.jsx(ie,{className:"h-4 w-4"}),"Položky ponuky"]}),i.length>0&&e.jsxs(ue,{children:[e.jsx(pe,{children:e.jsxs($,{children:[e.jsx(c,{children:"Popis"}),e.jsx(c,{className:"w-[100px] text-right",children:"Množstvo"}),e.jsx(c,{className:"w-[120px] text-right",children:"Cena/ks"}),e.jsx(c,{className:"w-[120px] text-right",children:"Spolu"}),e.jsx(c,{className:"w-[50px]"})]})}),e.jsx(je,{children:i.map(s=>e.jsxs($,{children:[e.jsx(d,{children:s.description}),e.jsx(d,{className:"text-right",children:s.quantity}),e.jsxs(d,{className:"text-right",children:[s.unit_price.toFixed(2)," €"]}),e.jsxs(d,{className:"text-right",children:[(s.quantity*s.unit_price).toFixed(2)," €"]}),e.jsx(d,{children:e.jsx(g,{variant:"ghost",size:"icon-sm",onClick:()=>ee(s.id),children:e.jsx(ve,{className:"h-4 w-4 text-muted-foreground hover:text-destructive"})})})]},s.id))})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-12 gap-3 items-end bg-card p-3 rounded border",children:[e.jsxs("div",{className:"md:col-span-3 space-y-2",children:[e.jsx(n,{className:"text-xs",children:"Predloha (Sklad)"}),e.jsxs(Z,{value:f,onValueChange:X,children:[e.jsx(E,{className:"h-8",children:e.jsx(O,{placeholder:"Vlastná položka"})}),e.jsxs(K,{children:[e.jsx(_,{value:"custom",children:"Vlastná položka"}),L.map(s=>e.jsxs(_,{value:s.id,children:[s.name," (",s.qty_available," ks)"]},s.id))]})]})]}),e.jsxs("div",{className:"md:col-span-4 space-y-2",children:[e.jsx(n,{className:"text-xs",children:"Popis *"}),e.jsx(o,{className:"h-8",value:b,onChange:s=>j(s.target.value),placeholder:"Názov položky alebo služby"})]}),e.jsxs("div",{className:"md:col-span-2 space-y-2",children:[e.jsx(n,{className:"text-xs",children:"Množstvo *"}),e.jsx(o,{type:"number",className:"h-8",min:"1",value:k,onChange:s=>Q(parseInt(s.target.value)||0)})]}),e.jsxs("div",{className:"md:col-span-2 space-y-2",children:[e.jsx(n,{className:"text-xs",children:"Cena/ks (€)"}),e.jsx(o,{type:"number",className:"h-8",min:"0",step:"0.01",value:B,onChange:s=>v(parseFloat(s.target.value)||0)})]}),e.jsx("div",{className:"md:col-span-1",children:e.jsx(g,{size:"sm",className:"w-full h-8",onClick:Y,children:e.jsx(ge,{className:"h-4 w-4"})})})]}),e.jsxs("div",{className:"grid gap-4 pt-4 border-t",children:[e.jsxs("div",{className:"flex justify-end gap-4 items-center",children:[e.jsx(n,{className:"w-24 text-right",children:"Zľava (€)"}),e.jsx(o,{type:"number",className:"w-32 h-8 text-right",min:"0",step:"0.01",value:u,onChange:s=>M(parseFloat(s.target.value)||0)})]}),e.jsxs("div",{className:"flex justify-end gap-4 items-center",children:[e.jsx(n,{className:"w-24 text-right",children:"Doprava (€)"}),e.jsx(o,{type:"number",className:"w-32 h-8 text-right",min:"0",step:"0.01",value:p,onChange:s=>z(parseFloat(s.target.value)||0)})]}),e.jsxs("div",{className:"flex justify-end gap-8 pt-2 mt-2 border-t border-dashed",children:[e.jsxs("div",{className:"text-right",children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"Základ"}),e.jsxs("p",{className:"font-medium",children:[S.toFixed(2)," €"]})]}),e.jsxs("div",{className:"text-right",children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"Upravený základ"}),e.jsxs("p",{className:"font-medium text-foreground",children:[(S-u+p).toFixed(2)," €"]})]}),e.jsxs("div",{className:"text-right",children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"DPH (20%)"}),e.jsxs("p",{className:"font-medium",children:[U.toFixed(2)," €"]})]}),e.jsxs("div",{className:"text-right",children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"Spolu s DPH"}),e.jsxs("p",{className:"text-xl font-bold text-primary",children:[W.toFixed(2)," €"]})]})]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(n,{children:"Poznámka"}),e.jsx(oe,{placeholder:"Interná poznámka k ponuke...",value:V,onChange:s=>q(s.target.value)})]})]}),e.jsxs(he,{children:[e.jsx(g,{variant:"outline",onClick:()=>x(!1),children:"Zrušiť"}),e.jsx(g,{onClick:se,disabled:w.isPending,children:w.isPending?e.jsxs(e.Fragment,{children:[e.jsx(ae,{className:"mr-2 h-4 w-4 animate-spin"}),"Vytváram..."]}):"Vytvoriť ponuku"})]})]})})}export{Pe as C};
